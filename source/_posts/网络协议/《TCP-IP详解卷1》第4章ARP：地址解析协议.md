---
title: 《TCP-IP详解卷1》第4章ARP：地址解析协议
date: 2019-05-24 16:29:12         
toc: true   
comments: true   
img: https://github.com/WenDeng/Picture_markdown/blob/master/picture/TCP-IP%E8%AF%A6%E8%A7%A3%E5%8D%B71/40.png?raw=true       
tags:
  - TCP/IP协议
  - 技术    
categories:    
  - 网络协议
---
数据链路如以太网或令牌环网都有自己的寻址机制（常常为48 bit地址），这是使用数据链路的任何网络层都必须遵从的。一个网络如以太网可以同时被不同的网络层使用。

当一台主机把以太网数据帧发送到位于同一局域网上的另一台主机时，是根据48bit的以太网地址来确定目的接口的。**设备驱动程序从不检查IP数据报中的目的IP地址**。

地址解析为这两种不同的地址形式提供映射：32 bit的IP地址和数据链路层使用的任何类型的地址。ARP（地址解析协议）和RAR P（逆地址解析协议）就是这样的两个映射协议。

ARP为IP地址到对应的硬件地址之间提供动态映射。我们之所以用动态这个词是因为这个过程是自动完成的，一般应用程序用户或系统管理员不必关心。

<!--more-->

### 1、从一个实例入手
当我们敲下以下命令：ftp bsdi，实际发生的过程如下。

![image](https://github.com/WenDeng/Picture_markdown/blob/master/picture/TCP-IP%E8%AF%A6%E8%A7%A3%E5%8D%B71/41.png?raw=true)

- （1）应用程序FTP客户端调用函数gethostbyname(3)把主机名（bsdi）转换成32 bit的IP地址。这个转换过程或者使用DNS，或者在较小网络中使用一个静态的主机文件（/etc/host s）。
- （2）FTP客户端请求TCP用得到的IP地址建立连接。
- （3）TCP发送一个连接请求分段到远端的主机，即用上述IP地址发送一份IP数据报。
- （4）如果目的主机在本地网络上，那么IP数据报可以直接送到目的主机上。如果目的主机在一个远程网络上，那么就通过IP选路函数来确定位于本地网络上的下一站路由器地址，并让它转发IP数据报。
- （5）假定是一个以太网，那么发送端主机必须把32bit的IP地址变换成48bit的以太网地址。逻辑Internet地址到对应的物理硬件地址需要进行翻译。这就是ARP的功能。
- （6）ARP发送一份称作ARP请求的以太网数据帧给以太网上的每个主机。这个过程称作广播，ARP请求数据帧中包含目的主机的IP地址（主机名为bsdi），其意思是“如果你是这个IP地址的拥有者，请回答你的硬件地址。”
- （7）目的主机的ARP层收到这份广播报文后，识别出这是发送端在寻问它的IP地址，于是发送一个ARP应答。这个ARP应答包含IP地址及对应的硬件地址。
- （8）收到ARP应答后，使ARP进行请求—应答交换的IP数据报现在就可以传送了。
- （9）发送IP数据报到目的主机。

在ARP背后有一个基本概念，那就是网络接口有一个硬件地址。**在硬件层次上进行的数据帧交换必须有正确的接口地址**。知道主机的IP地址并不能让内核发送一帧数据给主机。**内核（如以太网驱动程序）必须知道目的端的硬件地址才能发送数据**。ARP的功能是在32 bit的IP地址和采用不同网络技术的硬件地址之间提供动态映射。

### 2、ARP高速缓存
ARP高效运行的关键是由于每个主机上都有一个ARP高速缓存。这个高速缓存存放了最近Internet地址到硬件地址之间的映射记录。我们可以用arp(8)命令来检查ARP高速缓存。参数-a的意思是显示高速缓存中所有的内容。

### 3、ARP的分组格式
ARP的分组格式如下（42Byte: 28字节的ARP数据,14字节的以太网帧头）：

![image](https://github.com/WenDeng/Picture_markdown/blob/master/picture/TCP-IP%E8%AF%A6%E8%A7%A3%E5%8D%B71/42.png?raw=true)

- （1）以太网报头中的前两个字段是以太网的源地址和目的地址**。目的地址为全1的特殊地址是广播地址。电缆上的所有以太网接口都要接收广播的数据帧**。
- （2）以太网帧类型表示后面数据的类型。对于ARP请求或应答来说，该字段的值为0x0806。
- （3）硬件类型字段表示硬件地址的类型。它的值为1即表示以太网地址。
- （4）协议类型字段表示要映射的协议地址类型。它的值为0x0800即表示IP地址。**它的值与包含IP数据报的以太网数据帧中的类型字段的值相同**，这是有意设计的。
- （5）两个1字节的字段分别指出硬件地址和协议地址的长度，以字节为单位。对于以太网上IP地址的ARP请求或应答来说，它们的值分别为6和4。
- （6）操作字段指出四种操作类型，它们是ARP请求（值为1）、ARP应答（值为2）、RAR P请求（值为3）和RARP应答（值为4）。这个字段必需的，因为ARP请求和ARP应答的帧类型字段值是相同的。
- （7）接下来的四个字段是发送端的硬件地址、发送端的协议地址、目的端的硬件地址和目的端的协议地址。**注意，这里有一些重复信息：在以太网的数据帧报头中和ARP请求数据帧中都有发送端的硬件地址**。

对于一个ARP请求来说，除目的端硬件地址外的所有其他的字段都有填充值。**当系统收到一份目的端为本机的ARP请求报文后，它就把硬件地址填进去，然后用两个目的端地址分别替换两个发送端地址，并把操作字段置为2，最后把它发送回去**。

### 4、分析ARP实例
现在通过tcpdump获得一个TCP连接请求产生的ARP请求和应答，我们来看一下它的含义：

![image](https://github.com/WenDeng/Picture_markdown/blob/master/picture/TCP-IP%E8%AF%A6%E8%A7%A3%E5%8D%B71/43.png?raw=true)

在第1行中，源端主机的硬件地址是0:0:c0:6f:2d:40。目的端主机的硬件地址是ff:ff:ff:ff:ff:ff，这是一个以太网广播地址。紧接着的一个输出字段是arp，表明帧类型字段的值是0x0806，说明此数据帧是一个ARP请求或回答。在每行中，单词arp或ip后面的值60指的是以太网数据帧的最小长度,可以看出需要填充。第1行中的arp who-has字段表示作为ARP请求的这个数据帧中，目的IP地址是svr4的地址，发送端的IP地址是bsdi的地址。

从第2行中可以看到，尽管ARP请求是广播的，但是ARP应答的目的地址却是bsd（0:0:c0:6f:2d:40）。

第3行是第一个请求建立连接的TCP段。它的目的硬件地址是目的主机(svr4)。


### 5、如果ARP请求的主机不存在会发生什么？
如果查询的主机已关机或不存在会发生什么情况呢？用telnet 140.254.13.36发起连接，然后用tcpdump来查看状态，结果如下图：

![image](https://github.com/WenDeng/Picture_markdown/blob/master/picture/TCP-IP%E8%AF%A6%E8%A7%A3%E5%8D%B71/44.png?raw=true)

令人感兴趣的是看到多次进行ARP请求：第1次请求发生后5.5秒进行第2次请求，在24秒之后又进行第3次请求。注意，在线路上始终看不到TCP的报文段。我们能看到的是ARP请求。直到ARP回答返回时，TCP报文段才可以被发送，因为硬件地址到这时才可能知道。如果我们用过滤模式运行tcpdump命令，只查看TCP数据，那么将没有任何输出。

### 6、ARP代理
如果ARP请求是从一个网络的主机发往另一个网络上的主机，那么连接这两个网络的路由器就可以回答该请求，这个过程称作委托ARP或**ARP代理**。路由器的功能相当于目的主机的代理，把分组从其他主机转发给它。**一种攻击就是欺骗发起ARP请求的发送端，使它误以为路由器就是目的主机**。

![image](https://github.com/WenDeng/Picture_markdown/blob/master/picture/TCP-IP%E8%AF%A6%E8%A7%A3%E5%8D%B71/45.png?raw=true)

如图,当子网140.252.1（称作gemini）上的其他主机有一份IP数据报要传给地址为140.252.1.29的sun时，gemini比较网络号140.252和子网号1，因为它们都是相同的，随意当以太网中发送IP地址140.252.1.29的ARP请求。路由器netb识别出该I P地址属于它的一个拔号主机，于是把它的以太网接口地址1 4 0 . 2 5 2 . 1作为硬件地址来回答。主机g e m i n i通过以太网发送I P数据报到n e t b，n e t b通过拨号S L I P链路把数据报转发到s u n。这个过程对于所有1 4 0 . 2 5 2 . 1子网上的主机来说都是透明的，主机s u n实际上是在路由器n e t b后面进行配置的。



### 6、ARP高速缓存超时设置
### 6、ARP高速缓存超时设置
### 6、ARP高速缓存超时设置